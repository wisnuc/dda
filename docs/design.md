# Ding Drive Accelerator (DDA)

上海闻上科技



## 文档版本

第一版 20180116 - 上海闻上马天夫 (lewis.ma@winsuntech.cn) 156 1842 9080

* 给出DDA角色定义
* 建议使用客户端-DDA-云级联的管道方式传输
* 上传时建议实现write-back模式，云服务器需要建立文件传输状态资源




> @石安意见：
> * 建议DDA和用户角色对等； 客户端应该可以自己选择通过DDA上传下载还是自己上传下载，包括由客户端决策，客户端和DDA合作实现同一文件的上传下载；
> * 不建议在云端建立文件的新状态资源，影响范围太大无法短期评估影响，以及提议的方式是否可行，是否最佳方案；上传操作应该传输完全部文件之后才能分享；
> * 本地文件（或文件块）应该加密或者混淆存储；



第二版 20180118 - 上海闻上马天夫

* 沿用前一版本DDA定义和安全模型
* 基础下载模式基本沿用前一版设计，仍然是级联的in-band caching，但客户端和自主下载组合使用
* 基础上传从Write-back更改为Write-through模式
  * 删除Future设计
  * 删除DDA上的write-back任务资源
* 增加回填Cache操作，可通过提高并发连接进一步提高上传或下载速度，减少等待时间
* 增加本地Cache文件块列表API服务
* 增加文件加密存储

















## 设备角色

* Cloud
* DDA Server
* Client





## DDA定义

1. DDA也是Cloud的客户端；具有唯一帐号和授权访问机制，包括credential/token，可由管理员填写；
2. DDA不具有本地用户资源，所有authentication和authorization均由云端完成，client提供的钉钉用户认证信息是end-to-end加密传输的，因此DDA没有账户信息资源的安全性问题；
3. DDA具有本地文件资源；文件使用文件的hash标识；在三方协议中文件hash需要明文提供，DDA本地存储文件内容，因此DDA在文件资源上仅具有有限的安全性；





## DDA的本地服务

1. 提供mDNS广播，客户端可以搜索最近的mDNS设备；
2. 启动后和IP地址变更后向云端Publish本地地址，便于客户端搜索设备；
3. 提供DDA的身份信息和设备信息，客户端可以决定是否使用该DDA加速；




## DDA的加速服务 - Read (Download)

###下载

客户端向DDA发出下载文件请求，获得文件或者返回错误，使用HTTP/HTTPS GET实现。



客户端需提供：

1. 请求文件内容的密文，供云检查该用户操作和资源的有效性
2. 文件ID和Hash需明文提供，DDA需要理解该字段



> 可能的问题：因为用Query String提供请求，应注意URL长度限制



**Work Flow**

1. 先检查本地文件池，确定是cache hit还是cache miss
2. 向云服务发出请求，提供DDA的设备Id，认证信息，以及客户端发来的密文；
3. 如果已经cache hit，应调用云端语义为认证和授权操作的api（但不下载文件）
   1. 如果云端认证和授权成功，则从本地文件池中提取文件返回给客户端；
   2. 如果云端返回错误，向客户端返回错误；
4. 如果cache miss，应调用语义为认证和授权操作且下载文件的api
   1. 如果云端认证和授权成功，开始下载文件，同时向客户端stream文件并把文件保存到文件池，计算hash校验；
   2. 如果云端认证和授权失败，向客户端返回错误；


```
# when cache miss

Client      	DDA                           Cloud
   |------------>|                              |
   |             |                              |
   |        (cache miss)                        |
   |             |                              |
   |             |----(request file content)--->|
   |             |<----(reply file content) ----|
   |             |                              |
   |        (save a copy)                       |
   |<------------|                              |


Client      	DDA                           Cloud
   |------------>|                              |
   |             |                              |
   |        (cache hit)                         |
   |             |                              |
   |             |--------(request auth)------->|
   |             |<--------(reply auth)---------|
   |             |                              |
   |<------------|                              |
```

**优缺点**

1. 管道模式是常见的多级buffer实现读写方式，实现简单，客户端使用也简单；
2. 管道模式下DDA在IO路径上，无须外部干预cache的建立和管理，DDA可以根据LRU，hit rate等参数，在存储容量有限的情况下自动调节cache内容，无须外部干预；
3. 对单个文件下载，管道模式只与云建立一个连接，在云端有用户数、连接数、或每连接带宽限制时，全部文件内容使用管道模式读写并不是速度最快的方式，客户端还应该建立额外的传输通道加速；




### 回填Cache

回填cache指的是客户端单独下载文件内容，把下载的内容写入DDA建立Cache；使用HTTP/HTTPS POST (multipart/formdata)。

如果多设备同时建立（多）连接并发下载可以显著提升下载速度，可有效减少客户端的等待时间；但是设备自主下载的内容并不在DDA的Cache中，可能造成多次下载浪费带宽；通过提供回填模式建立Cache，可避免这种带宽浪费。

客户端需提供：

1. 密文提供转发给云的内容，供云确认该用户操作和资源信息的有效性；
2. 文件ID和Hash需明文提供



**Work Flow**

1. 客户端发起POST请求，在前面的Part里提供需要云确认操作有效性的内容；
2. DDA向云发起请求检查该建立Cache的操作是否有效；
3. DDA在向云请求的同时把后面的文件内容Part写入文件系统，同时计算Hash；（并发）
4. 成功发生在2/3均成功结束时；
5. 如果云返回错误，或者文件内容Hash写入先完成且Hash计算结果不一致，则操作失败，DDA向客户端返回错误。




```
# Paralleling

Client      	DDA                                   Cloud
   |------------>|                                      |
   |             |                                      |
   |	   ------|--------------------------------------|----
   |       | par |----(request auth/integrity check)--->|   |
   |       |     |<------(reply valid or not) ----------|   |
   |       |-----|--------------------------------------|---|
   |       | stream & hash                              |   |
   |       ------|--------------------------------------|----
   |             |                                      |
   |<------------|                                      |
```



### 组合使用

客户端可以仅使用通过DDA的模式下载，如果DDA发生故障，直接从云下载；



如果要获得更快的下载速度，客户端可以把需要下载的文件分成两个不同的部分，一个部分使用DDA下载，另一个部分自主下载并向DDA回填Cache。




## DDA的加速服务 - Write (Upload)

> 与前一版本不同，为保证文件服务完整性，本版本设计为Write-Through模式；



### 上传

客户端向DDA发出上传文件请求，使用HTTP/HTTPS Post实现（multipart/formdata）。



客户端需提供：

1. 向云请求的密文
2. 文件ID和Hash需明文提供
3. 文件内容





**DDA Work Flow**

1. 客户端向DDA发出请求；
2. DDA把客户端发来的内容解析和重组成向云端发送的formdata，同时记录文件ID与Hash，把客户端发来的文件Part保存到本地，同时验证Hash；
3. 如果一切成功，在文件内容传输完之后，云和DDA均有该内容的完整副本；
4. 如果失败向客户端返回错误；




（Sequence Diagram略）



### 回填Cache和组合模式

在前一节讨论的回填和组合模式可直接应用于上传过程。



如果多连接上传有明显的提速能力，客户端可以把一部分内容自行上传至云，另外一部分通过DDA传输；自行传输的部分可以直接填入DDA，接口上DDA并不区分（也无法区分）客户端是在上传还是下载。



## 文件块Cache列表

DDA应提供本地某个文件的文件块列表。

DDA在接收到客户端的查询请求后向云端请求该用户访问该资源的权限检查。

该访问应该提供文件ID和文件内容Hash，如果文件内容发生变化，DDA应根据返回的错误信息清理过期文件Cache。





## 钉钉账户信息加密

云端应该为钉钉用户分配一对公密钥，一个保存在云端，另一个下发到设备；该公密钥对仅用于含DDA的三方协议；客户端发起的请求可以用设备密钥加密，云端用公钥解开请求密文，这样保证账户信息对DDA而言是不可见和不可伪造的；

如果需要防护DDA被恶意获取权限，重用用户的请求密文向服务器发起攻击，可以加入其他防止中间人攻击的办法，和/或要求DDA在发起请求时提供Proof-of-work；



## 文件内容本地加密

采用符合钉盘安全性的混淆、加密、和密钥管理方式，由钉盘安全部门提出要求，DDA开发者负责实现。





## 系统启动

DDA启动时向云端注册，提供自己的局域网IP地址；

和云端保持连接让云端知道自己的在线/离线状态；






## 云端要求汇总

1. 常规的设备帐号体系，每帐号应具有online/offline状态和局域网IP地址信息资源；
   1. online/offline的实现看云端框架如何实现方便；IP地址信息资源的生命周期不超过online状态；
2. 用户资源增加DDA公密钥；该公密钥也可以广泛用于其他需要端到端加密请求的使用场景；
3. DDA开发者需要先看到云盘的API文档，确定需要增加的接口，用于：
   1. 下载操作中cache hit时，云的认证和授权检查；
   2. 上传操作中，逻辑和设备上传一样，但云需要显式知道这是DDA的上传，因此接口形式有变化；
   3. 回填Cache时，DDA向云请求该操作的有效性；
   4. 向客户端提供DDA上Cache的文件块列表，需要云认证和授权检查；







