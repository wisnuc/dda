# Ding Drive Accelerator (DDA)

上海闻上科技



## 文档版本

当前版本 3



第1版 20180116 - 上海闻上马天夫 (lewis.ma@winsuntech.cn) 156 1842 9080

* 给出DDA角色定义
* 建议使用客户端-DDA-云级联的管道方式传输
* 上传时建议实现write-back模式，云服务器需要建立文件传输状态资源




> @石安意见：
> * 建议DDA和用户角色对等； 客户端应该可以自己选择通过DDA上传下载还是自己上传下载，包括由客户端决策，客户端和DDA合作实现同一文件的上传下载；
> * 不建议在云端建立文件的新状态资源，影响范围太大无法短期评估影响，以及提议的方式是否可行，是否最佳方案；上传操作应该传输完全部文件之后才能分享；
> * 本地文件（或文件块）应该加密或者混淆存储；



第2版 20180118 - 上海闻上马天夫

* 沿用前一版本DDA定义和安全模型
* 基础下载模式基本沿用前一版设计，仍然是级联的in-band caching，但客户端和自主下载组合使用
* 基础上传从Write-back更改为Write-through模式
  * 删除Future设计
  * 删除DDA上的write-back任务资源
* 增加回填Cache操作，可通过提高并发连接进一步提高上传或下载速度，减少等待时间
* 增加本地Cache文件块列表API服务
* 增加文件加密存储





> @石安意见：
> * 建议把DDA改成旁路设备，不位于客户端和云的数据传输通道上；
> * DDA向云下载资源可以使用一次性授权凭据




第3版 20180119 - 上海闻上马天夫

* 修改前一版本DDA定义
* 将DDA从云和客户端之间的传输通道中移除，成为旁路设备，分别与云和客户端通讯
* 增加云控制DDA建立Cache的设计，DDA从云下载文件使用一次性授权凭据
* 保留客户端直接向DDA写入Cache的设计，但决策者修改为云，不是客户端自主决策






## 设备角色

* Cloud
* DDA Server
* Client





## DDA定义

1. DDA是Cloud的客户端；具有唯一帐号和授权访问机制，包括credential/token，可由管理员填写；

2. DDA不具有本地用户资源，所有客户端访问DDA时的authentication和authorization均由云端完成；客户端在访问DDA时提供的钉钉用户认证信息是客户端与云之间端到端加密的，DDA没有账户信息资源的安全性问题；

3. DDA具有本地文件（块）资源；文件（块）使用文件的uuid和hash标识；

4. DDA创建本地Cache资源由云发起：

   1. 云端向DDA下发一次性获取文件资源的授权访问凭据；DDA使用该凭据从云端下载资源建立cache；
   2. 创建资源过程可由客户端代劳，DDA负责建立cache，服务其他客户端；DDA授权客户端操作可以：
      1. 通过云进行认证、授权和数据有效性检查；
      2. 云向客户端下发签名的操作请求，DDA通过验证签名验证操作请求的有效性；

5. DDA需安全存储本地文件，假定硬盘丢失或被窃取，其数据无法还原成明文；

   ​



## DDA的本地服务

1. 提供mDNS广播，客户端可以搜索最近的mDNS设备；
2. 启动后和IP地址变更后向云端Publish本地地址，便于客户端搜索设备；
3. 提供DDA的身份信息和设备信息，客户端可以决定是否使用该DDA加速；




## DDA向客户端提供的文件服务

DDA仅向客户端提供本地Cache的查询，建立和下载功能；客户端不依赖DDA实现下载和上传；DDA不位于客户端和云之间的传输通道上。



所有服务请求的认证、授权、信息有效性检查，均在云端完成；与这些工作有关的信息均使用客户端和云之间的端到端加密；DDA在接收到请求后先把请求密文转发给云，云检查成功后DDA才会履行客户端访问本地资源的操作。



### 下载

客户端向DDA发出请求，DDA可以返回以下内容（不同API返回不同内容）：

1. 本地该文件的版本（或完整文件hash）
2. 本地具有的该文件的文件块列表
3. 本地的某文件块内容





客户端需提供：
1. 和云端到端加密的请求密文；
2. DDA需要文件ID，Hash（和/或版本）查找本地Cache；这些字段建议明文提供：
   1. 更符合Restful API的URL资源表述规范；
   2. 如果本地无Cache，可减少一次DDA向云的请求；




### 创建文件Cache

客户端向DDA发出请求创建一个本地文件（块）Cache。



与上一版本设计中所述的客户端自主决策写入DDA不同，本版本中客户端向DDA的写入应该由云决策；即在客户端向云发送文件完成后，由云通过返回数据告知客户端是否应该将该文件块写入指定DDA。



DDA对写入请求的验证可以和下载一样通过云端请求完成，也可以在云端直接下发操作签名，客户端把签名交给DDA，DDA验证签名通过即可执行操作。



DDA会做文件数据完整性检查。



## 云对DDA的Cache控制

云把DDA看作一个位于某处的可控Cache设备，云可以：

1. 要求DDA为某个文件（块）建立Cache；方式是下发业务要求和一次性文件访问授权凭据，DDA使用该凭据访问文件；
2. 可以在云端文件更新时主动要求DDA废除该Cache；但该业务要求建议使用Lazy方式实现，DDA在客户端请求时发现本地Cache过期时删除旧文件Cache，这样云端不需要建立DDA对文件变化的Observer或Pub/Sub机制；




云端应该为每个DDA设备建立它应该Cache的文件块资源，供DDA查询；同时增加该资源时，应该通过通知通道向DDA下发消息；这里有两种设计可能性：

1. 云端维护一个DDA应该Cache的所有文件列表，DDA可以根据该资源请求下载凭据和下载文件，建立Cache；也可以根据该资源删除过期数据；还可以标记该资源的Cache状态，在这种设计下云端对每个DDA上Cache的数据都了解；这是资源建模，缺点是数据集可能很大，DDA向云的状态更新未必及时；DDA无权删除该资源。
2. 云端只维护一个DDA应该近期Cache的文件列表，DDA根据该资源下载文件建立Cache；DDA可以删除该资源，如果该资源在DDA上已有副本；这种方式是资源操作建模，云不具有DDA上Cache的完整描述，但实现简单，两端没有维护数据一致的责任。



无论哪种情况，云端维护该资源的依据可以是：

1. 文件的访问权限和共享情况
2. 用户所处的网络位置（客户端自己报告）
3. DDA所处的网络位置（DDA可以向云端报告自己的子网路由器的MAC地址或其他唯一标识符号）





### Cache Miss

另外一个可能可以提供云端决策参考依据的是DDA的Cache Miss事件；



前一节所述的下载功能，并未考虑DDA向客户端提供一个本地具有的Cache列表；因为数据集庞大，云端和DDA之间要diff，这个操作比较难以实现；如果该操作不提供的话，客户端只能用请求单一文件的API问DDA，如果DDA没有该文件，DDA可以向云汇报，作为云下发Cache命令的依据，这和CDN的工作方式是类似的。



### Cache的生命周期

DDA设计的核心问题是Cache的生命周期管理，尤其是生命周期的开始。要回答：

1. 谁负责触发建立Cache
2. 建立Cache时数据传输的安全性如何保证




在本文档不断更新的过程中我们讨论过多种设计：

1. 在前面两个版本中的write-back/write-through模式下，DDA是自主建立Cache；
2. 在上一版本中加入的客户端直接写入，是客户端自主决策建立Cache；
3. 在本版本中，云下发的下载指令是云决策建立Cache；客户端写入DDA是客户端代劳云的数据传输工作，最终决策者仍然是云；




云，DDA，和客户端三者相比，只有云是能看到所有设备的，包括客户端和DDA；所以从管理而言，由云决策可以协调所有的DDA设备和客户端设备，使之协同工作。



该设计对于多个DDA设备存在的情况下可以明显优于DDA自己决策的设计，也明显对文件传输安全性有利。该设计的不足之处是对文件上传没有帮助（也许未来我们可以想出更好的办法）。



在回答了第一个问题之后，第二个问题就简化了，DDA从云和客户端之间的传输通道中移除，云向DDA下发Cache指令可以使用一次性授权凭据；客户端向DDA的写入可以用云授权，也可以用云签名的凭据；是否需要写入DDA可以在客户端上传文件后，由云通过返回结果告知客户端，客户端不自己作决策，客户端缺乏足够多和足够好的决策依据。





## 钉钉用户账户信息加密（建议）

云端应该为钉钉用户分配一对公密钥（或者SSK，Shared Secret Key，也可以），一个保存在云端，另一个下发到设备；

* 该公密钥对仅用于客户端访问DDA时加密请求，实现客户端和云之间的端到端加密；
* 该公密钥的生命周期可以是短暂的，类似token；





## 文件内容本地加密

采用符合钉盘安全性的混淆、加密、和密钥管理方式，由钉盘安全部门提出要求，DDA开发者负责实现。





## 系统启动

DDA启动时向云端注册，提供自己的局域网IP地址，提供自己的局域网地址（网关的MAC或其他唯一识别ID）；

和云端保持连接让云端知道自己的在线/离线状态，发送和获取通知；






## 云端要求汇总

1. 常规的设备帐号体系，每帐号应具有online/offline状态和局域网IP地址信息资源；
   1. online/offline的实现看云端框架如何实现方便；IP地址信息资源的生命周期不超过online状态；
2. 用户资源增加一对公密钥（或SSK），用于端到端加密，或者提供其他类似的端到端加密方式；
3. 云端需要建立DDA Cache命令资源，供DDA查询和执行；DDA在完成Cache后可以删除资源或标记完成；
4. 云端可以向客户端要求写入某文件/文件块到某DDA；






## 需要安全性评估的地方

1. 当前设计中，客户端向DDA发出请求获取本地Cache信息，设计为客户端和云使用公密钥或共享密钥加密请求，DDA转发密文到云上验证授权；
2. 当前设计中，客户端（代云）向DDA发出建立本地Cache的请求时，另一种可行的授权验证设计是请求操作由云提供签名；



以上两种DDA访问授权检查在安全性方面是否可行请安全技术人员尽快评估，如果不行请给出可行方式的建议。



